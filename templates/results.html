<!DOCTYPE html>
<html>
<head>
  <title>Retention Analysis Results</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 20px;
    }
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .meta { 
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .scores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .score-card {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .score-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .score-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .card { 
      background: rgba(255,255,255,0.95);
      border-radius: 12px; 
      padding: 25px; 
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .card h2 {
      margin-top: 0;
      color: #4a5568;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    .hooks-grid {
      display: grid;
      gap: 12px;
      margin: 15px 0;
    }
    .hook-item {
      background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
      color: #2d3436;
      padding: 15px;
      border-radius: 8px;
      font-style: italic;
      font-weight: 500;
      border-left: 4px solid #e17055;
    }
    .formula-box {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      border: 1px solid #81ecec;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    .timing-box {
      background: linear-gradient(135deg, #d1f2eb 0%, #a8e6cf 100%);
      border: 1px solid #00b894;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    .improvements-box {
      background: linear-gradient(135deg, #ffe8cc 0%, #ffcc8f 100%);
      border: 1px solid #fdcb6e;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    pre { 
      white-space: pre-wrap; 
      font-family: inherit;
      margin: 0;
      line-height: 1.6;
    }
    
    /* Button styling */
    .copy-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 15px;
      margin-right: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
      display: inline-block;
      min-height: 40px;
      min-width: 120px;
    }
    .copy-btn:hover {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    .copy-btn:active {
      transform: translateY(0);
    }
    .copy-btn.copied {
      background: #10b981;
    }
    
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
      gap: 15px; 
      margin: 20px 0;
    }
    .frame-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .frame-card img { 
      width: 100%; 
      height: auto; 
    }
    .back-link {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      color: white;
      text-decoration: none;
      padding: 15px 30px;
      border-radius: 30px;
      margin-top: 30px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.3s;
    }
    .back-link:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    .tag { 
      display: inline-block; 
      background: rgba(102, 126, 234, 0.1);
      color: #667eea; 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-size: 12px; 
      margin-right: 8px; 
      margin-bottom: 6px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    /* Formula tab styling */
    .formula-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 25px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      padding-bottom: 15px;
    }
    .formula-tab {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border: 2px solid rgba(102, 126, 234, 0.3);
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .formula-tab:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
    }
    .formula-tab.active {
      background: #667eea;
      color: white;
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
      border-color: #667eea;
    }
    .formula-content {
      display: none;
      animation: fadeIn 0.4s ease-in;
    }
    .formula-content.active {
      display: block;
    }
    .formula-content h4 {
      margin: 0 0 15px 0;
      color: #4a5568;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .formula-text {
      white-space: pre-wrap;
      font-family: inherit;
      margin: 0;
      line-height: 1.6;
      background: rgba(255, 255, 255, 0.6);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Success message styling */
    .success-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      opacity: 0;
      transform: translateX(100px);
      transition: all 0.3s ease;
    }
    .success-message.show {
      opacity: 1;
      transform: translateX(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ Retention Analysis</h1>
      <p>Goal: {{ goal.replace('_', ' ').title() }}</p>
    </div>

    <div class="meta">
      <div><strong>üìπ URL:</strong> {{ tiktok_url }}</div>
      {% if creator_note %}<div><strong>üìù Your note:</strong> {{ creator_note }}</div>{% endif %}
      <div style="margin-top: 12px;">
        <span class="tag">{{ platform.title() }}</span>
        <span class="tag">{{ target_duration }}s target</span>
        <span class="tag">{{ frames_count | default(0) }} frames analyzed</span>
        <span class="tag">{{ strategy.title() }} sampling</span>
      </div>
    </div>

    {% if scores %}
    <div class="card">
      <h2>üìä Performance Scores</h2>
      <div class="scores-grid">
        {% if scores.hook_strength %}
        <div class="score-card">
          <div class="score-value">{{ scores.hook_strength }}/10</div>
          <div class="score-label">Hook Strength</div>
        </div>
        {% endif %}
        {% if scores.promise_clarity %}
        <div class="score-card">
          <div class="score-value">{{ scores.promise_clarity }}/10</div>
          <div class="score-label">Promise Clarity</div>
        </div>
        {% endif %}
        {% if scores.retention_design %}
        <div class="score-card">
          <div class="score-value">{{ scores.retention_design }}/10</div>
          <div class="score-label">Retention Design</div>
        </div>
        {% endif %}
        {% if scores.engagement_potential %}
        <div class="score-card">
          <div class="score-value">{{ scores.engagement_potential }}/10</div>
          <div class="score-label">Engagement Potential</div>
        </div>
        {% endif %}
        {% if scores.goal_alignment %}
        <div class="score-card">
          <div class="score-value">{{ scores.goal_alignment }}/10</div>
          <div class="score-label">Goal Alignment</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div class="card">
      <h2>üé£ Hook Analysis & Breakdown</h2>
      <pre>{{ analysis }}</pre>
    </div>

    {% if timing_breakdown %}
    <div class="card">
      <h2>‚è±Ô∏è Timing Breakdown</h2>
      <div class="timing-box">
        <pre>{{ timing_breakdown }}</pre>
      </div>
    </div>
    {% endif %}

    {% if improvements %}
    <div class="card">
      <h2>üöÄ Specific Improvements</h2>
      <div class="improvements-box">
        <pre>{{ improvements }}</pre>
      </div>
    </div>
    {% endif %}

    <div class="card">
      <h2>üí° Alternative Hooks to Test</h2>
      {% if hooks and hooks | length > 0 %}
        <div class="hooks-grid">
          {% for hook in hooks %}
            <div class="hook-item">"{{ hook }}"</div>
          {% endfor %}
        </div>
        <button class="copy-btn" data-action="copy-hooks">Copy All Hooks</button>
      {% else %}
        <p>No alternative hooks generated.</p>
      {% endif %}
    </div>

    {% if formula or basic_formula %}
    <div class="card">
      <h2>üìã Your Reusable Formulas</h2>
      
      <!-- Formula Type Selector -->
      <div class="formula-selector">
        <button class="formula-tab active" data-formula="basic">Basic Structure</button>
        <button class="formula-tab" data-formula="timing">With Timing</button>
        <button class="formula-tab" data-formula="template">Template Format</button>
        <button class="formula-tab" data-formula="psychology">Psychology Framework</button>
      </div>

      <!-- Basic Structure -->
      <div id="basic-formula" class="formula-content active">
        <div class="formula-box">
          <h4>üìù Basic Structure</h4>
          <pre class="formula-text">{{ basic_formula or formula }}</pre>
          <button class="copy-btn" data-action="copy-formula" data-target="basic-formula">Copy Basic Formula</button>
        </div>
      </div>

      <!-- Timing-Based Formula -->
      <div id="timing-formula" class="formula-content">
        <div class="formula-box">
          <h4>‚è±Ô∏è Step-by-Step with Timing</h4>
          <pre class="formula-text">{{ timing_formula or "TIMING-BASED FORMULA FOR " + goal.upper() + ":\n\n0-3 seconds: Hook with strong opener that grabs attention immediately\n3-7 seconds: Set clear promise of what they'll learn/discover by the end\nMiddle section: Build engagement with progressive reveals and retention tactics\nFinal 10 seconds: Deliver satisfying payoff that fulfills the promise\n\nKey Timing Notes:\n- Hook must grab attention in first 1-2 seconds\n- Promise clarification by 5-second mark\n- Save strongest revelation for final moments\n- End with engagement trigger (question/challenge)" }}</pre>
          <button class="copy-btn" data-action="copy-formula" data-target="timing-formula">Copy Timing Formula</button>
        </div>
      </div>

      <!-- Template Format -->
      <div id="template-formula" class="formula-content">
        <div class="formula-box">
          <h4>üìã Template Format</h4>
          <pre class="formula-text">{{ template_formula or "TEMPLATE FORMAT FOR " + goal.replace('_', ' ').upper() + ":\n\n\"[STRONG OPENER] + [CLEAR PROMISE] + [ENGAGING BUILD] + [SATISFYING PAYOFF] + [ENGAGEMENT HOOK]\"\n\nExample Structure:\n\"[Controversial statement] + [Promise to explain why] + [Build case with examples] + [Deliver the insight] + [Question to drive comments]\"\n\nFill in your content:\n- Strong Opener: ________________\n- Clear Promise: ________________\n- Engaging Build: ________________\n- Satisfying Payoff: ________________\n- Engagement Hook: ________________" }}</pre>
          <button class="copy-btn" data-action="copy-formula" data-target="template-formula">Copy Template</button>
        </div>
      </div>

      <!-- Psychology Framework -->
      <div id="psychology-formula" class="formula-content">
        <div class="formula-box">
          <h4>üß† Psychology Framework</h4>
          <pre class="formula-text">{{ psychology_formula or "PSYCHOLOGY-BASED RETENTION FRAMEWORK:\n\n1. CURIOSITY GAP CREATION\n   ‚Üí Create a question they MUST know the answer to\n   ‚Üí Example: \"Why your [expertise area] isn't working\"\n\n2. PROMISE ESTABLISHMENT\n   ‚Üí What will they learn/gain by watching?\n   ‚Üí Time-bound commitment: \"in the next 30 seconds\"\n\n3. DELAYED GRATIFICATION TACTICS\n   ‚Üí Mini-reveals that build anticipation\n   ‚Üí \"But first, let me tell you about...\"\n   ‚Üí Progressive disclosure of information\n\n4. SATISFYING PAYOFF DELIVERY\n   ‚Üí Answer the curiosity gap completely\n   ‚Üí Add bonus insight they didn't expect\n   ‚Üí Emotional + practical satisfaction\n\n5. ENGAGEMENT AMPLIFICATION\n   ‚Üí Question that drives comments\n   ‚Üí Challenge that encourages shares\n   ‚Üí Hook for follow-up content\n\nPSYCHOLOGICAL TRIGGERS:\n‚úì Social proof (\"Most people don't know...\")\n‚úì Authority (\"As someone who...\")\n‚úì Scarcity (\"This only works if...\")\n‚úì Reciprocity (\"I'm sharing this because...\")\n‚úì Curiosity (\"The real reason is...\")" }}</pre>
          <button class="copy-btn" data-action="copy-formula" data-target="psychology-formula">Copy Framework</button>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card">
      <h2>üìú Full Transcript</h2>
      <pre>{{ transcript }}</pre>
    </div>

    <div class="card">
      <h2>üñºÔ∏è Frame Analysis</h2>
      <div class="grid">
        {% for img in frame_gallery %}
          <div class="frame-card"><img src="{{ img }}" alt="Video frame"></div>
        {% endfor %}
      </div>
      
      <!-- Collapsible Frame Details -->
      <details style="margin-top: 20px;">
        <summary style="cursor: pointer; color: #667eea; font-weight: 600;">
          ‚ñ∂ View Frame-by-Frame Analysis (Used for AI Context)
        </summary>
        <div style="max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin-top: 10px;">
          {% if frame_summaries and frame_summaries | length > 1 %}
            {% for block in frame_summaries %}
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px; margin: 8px 0; font-size: 0.9rem;">
                <pre style="white-space: pre-wrap; margin: 0; font-family: inherit;">{{ block }}</pre>
              </div>
            {% endfor %}
          {% else %}
            <pre style="white-space: pre-wrap; margin: 0; font-family: inherit; font-size: 0.9rem;">{{ frame_summary | default("No frame analysis available", true) }}</pre>
          {% endif %}
        </div>
      </details>
    </div>

    <a href="/" class="back-link">‚Üê Analyze Another Video</a>
  </div>

  <script>
// BULLETPROOF SOLUTION: Using event delegation and data attributes
console.log('üöÄ Initializing bulletproof JavaScript...');

// Main event handler using event delegation
document.addEventListener('click', function(event) {
  const target = event.target;
  
  // Handle formula tab switching
  if (target.classList.contains('formula-tab')) {
    console.log('üóÇÔ∏è Formula tab clicked:', target.dataset.formula);
    handleFormulaTab(target);
    return;
  }
  
  // Handle copy buttons
  if (target.classList.contains('copy-btn')) {
    const action = target.dataset.action;
    console.log('üìã Copy button clicked:', action);
    
    if (action === 'copy-hooks') {
      handleCopyHooks();
    } else if (action === 'copy-formula') {
      const targetId = target.dataset.target;
      handleCopyFormula(targetId);
    }
    return;
  }
});

// Handle formula tab switching
function handleFormulaTab(clickedTab) {
  const formulaType = clickedTab.dataset.formula;
  
  try {
    // Remove active class from all tabs
    document.querySelectorAll('.formula-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Hide all formula contents
    document.querySelectorAll('.formula-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Activate clicked tab
    clickedTab.classList.add('active');
    
    // Show corresponding content
    const targetContent = document.getElementById(formulaType + '-formula');
    if (targetContent) {
      targetContent.classList.add('active');
      console.log('‚úÖ Activated formula:', formulaType);
    } else {
      console.error('‚ùå Could not find content for:', formulaType);
    }
  } catch (error) {
    console.error('‚ùå Error switching formula tab:', error);
  }
}

// Handle copying all hooks
function handleCopyHooks() {
  try {
    const hooks = [];
    document.querySelectorAll('.hook-item').forEach(item => {
      const text = item.textContent.replace(/"/g, '').trim();
      hooks.push(text);
    });
    
    if (hooks.length === 0) {
      showMessage('No hooks found to copy', 'error');
      return;
    }
    
    const allHooksText = hooks.join('\n');
    copyToClipboard(allHooksText);
    console.log('‚úÖ Copied all hooks:', hooks.length);
  } catch (error) {
    console.error('‚ùå Error copying hooks:', error);
    showMessage('Error copying hooks', 'error');
  }
}

// Handle copying formula content
function handleCopyFormula(targetId) {
  try {
    const element = document.getElementById(targetId);
    if (!element) {
      console.error('‚ùå No element found with ID:', targetId);
      showMessage('Error: Could not find formula content', 'error');
      return;
    }
    
    const textElement = element.querySelector('.formula-text');
    if (!textElement) {
      console.error('‚ùå No text element found in:', targetId);
      showMessage('Error: Could not find text to copy', 'error');
      return;
    }
    
    const text = textElement.textContent || textElement.innerText;
    copyToClipboard(text);
    console.log('‚úÖ Copied formula:', targetId);
  } catch (error) {
    console.error('‚ùå Error copying formula:', error);
    showMessage('Error copying formula', 'error');
  }
}

// Copy to clipboard function
function copyToClipboard(text) {
  // Try modern clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      console.log('‚úÖ Copy successful via clipboard API');
      showMessage('‚úÖ Copied to clipboard!', 'success');
    }).catch((err) => {
      console.error('‚ùå Clipboard API failed:', err);
      fallbackCopy(text);
    });
  } else {
    console.log('üìã Clipboard API not available, using fallback');
    fallbackCopy(text);
  }
}

// Fallback copy method
function fallbackCopy(text) {
  try {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    const successful = document.execCommand('copy');
    document.body.removeChild(textArea);
    
    if (successful) {
      console.log('‚úÖ Copy successful via execCommand');
      showMessage('‚úÖ Copied to clipboard!', 'success');
    } else {
      console.error('‚ùå execCommand copy failed');
      showMessage('‚ùå Copy failed - please select and copy manually', 'error');
    }
  } catch (err) {
    console.error('‚ùå Fallback copy failed:', err);
    showMessage('‚ùå Copy failed - please select and copy manually', 'error');
  }
}

// Show success/error messages
function showMessage(text, type) {
  // Remove any existing messages
  const existingMessage = document.querySelector('.success-message');
  if (existingMessage) {
    existingMessage.remove();
  }
  
  // Create new message
  const message = document.createElement('div');
  message.className = 'success-message';
  message.textContent = text;
  
  if (type === 'error') {
    message.style.background = '#ef4444';
  }
  
  document.body.appendChild(message);
  
  // Show message
  setTimeout(() => message.classList.add('show'), 100);
  
  // Hide message after 3 seconds
  setTimeout(() => {
    message.classList.remove('show');
    setTimeout(() => message.remove(), 300);
  }, 3000);
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('üéâ DOM loaded - all functionality ready');
  console.log('üìä Formula tabs found:', document.querySelectorAll('.formula-tab').length);
  console.log('üìã Copy buttons found:', document.querySelectorAll('.copy-btn').length);
  console.log('üé£ Hook items found:', document.querySelectorAll('.hook-item').length);
});

console.log('‚úÖ Bulletproof JavaScript loaded successfully');
</script>
</body>
</html>