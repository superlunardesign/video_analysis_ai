<!DOCTYPE html>
<html>
<head>
  <title>Retention Analysis Results</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 20px;
    }
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .meta { 
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .scores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .score-card {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .score-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .score-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .card { 
      background: rgba(255,255,255,0.95);
      border-radius: 12px; 
      padding: 25px; 
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .card h2 {
      margin-top: 0;
      color: #4a5568;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    .hooks-grid {
      display: grid;
      gap: 12px;
      margin: 15px 0;
    }
    .hook-item {
      background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
      color: #2d3436;
      padding: 15px;
      border-radius: 8px;
      font-style: italic;
      font-weight: 500;
      border-left: 4px solid #e17055;
    }
    .formula-box {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      border: 1px solid #81ecec;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    .timing-box {
      background: linear-gradient(135deg, #d1f2eb 0%, #a8e6cf 100%);
      border: 1px solid #00b894;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    .improvements-box {
      background: linear-gradient(135deg, #ffe8cc 0%, #ffcc8f 100%);
      border: 1px solid #fdcb6e;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    pre { 
      white-space: pre-wrap; 
      font-family: inherit;
      margin: 0;
      line-height: 1.6;
    }
    .copy-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      transition: background 0.3s;
    }
    .copy-btn:hover {
      background: #5a67d8;
    }
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
      gap: 15px; 
      margin: 20px 0;
    }
    .frame-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .frame-card img { 
      width: 100%; 
      height: auto; 
    }
    .back-link {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      color: white;
      text-decoration: none;
      padding: 15px 30px;
      border-radius: 30px;
      margin-top: 30px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.3s;
    }
    .back-link:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    .tag { 
      display: inline-block; 
      background: rgba(102, 126, 234, 0.1);
      color: #667eea; 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-size: 12px; 
      margin-right: 8px; 
      margin-bottom: 6px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
  </style>
  <script>
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert("Copied to clipboard!");
      }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert("Copied to clipboard!");
      });
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ Retention Analysis</h1>
      <p>Goal: {{ goal.replace('_', ' ').title() }}</p>
    </div>

    <div class="meta">
      <div><strong>üìπ URL:</strong> {{ tiktok_url }}</div>
      {% if creator_note %}<div><strong>üìù Your note:</strong> {{ creator_note }}</div>{% endif %}
      <div style="margin-top: 12px;">
        <span class="tag">{{ platform.title() }}</span>
        <span class="tag">{{ target_duration }}s target</span>
        <span class="tag">{{ frames_count | default(0) }} frames analyzed</span>
        <span class="tag">{{ strategy.title() }} sampling</span>
      </div>
    </div>

    {% if scores %}
    <div class="card">
      <h2>üìä Performance Scores</h2>
      <div class="scores-grid">
        {% if scores.hook_strength %}
        <div class="score-card">
          <div class="score-value">{{ scores.hook_strength }}/10</div>
          <div class="score-label">Hook Strength</div>
        </div>
        {% endif %}
        {% if scores.promise_clarity %}
        <div class="score-card">
          <div class="score-value">{{ scores.promise_clarity }}/10</div>
          <div class="score-label">Promise Clarity</div>
        </div>
        {% endif %}
        {% if scores.retention_design %}
        <div class="score-card">
          <div class="score-value">{{ scores.retention_design }}/10</div>
          <div class="score-label">Retention Design</div>
        </div>
        {% endif %}
        {% if scores.engagement_potential %}
        <div class="score-card">
          <div class="score-value">{{ scores.engagement_potential }}/10</div>
          <div class="score-label">Engagement Potential</div>
        </div>
        {% endif %}
        {% if scores.goal_alignment %}
        <div class="score-card">
          <div class="score-value">{{ scores.goal_alignment }}/10</div>
          <div class="score-label">Goal Alignment</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div class="card">
      <h2>üé£ Hook Analysis & Breakdown</h2>
      <pre>{{ analysis }}</pre>
    </div>

    {% if timing_breakdown %}
    <div class="card">
      <h2>‚è±Ô∏è Timing Breakdown</h2>
      <div class="timing-box">
        <pre>{{ timing_breakdown }}</pre>
      </div>
    </div>
    {% endif %}

    {% if improvements %}
    <div class="card">
      <h2>üöÄ Specific Improvements</h2>
      <div class="improvements-box">
        <pre>{{ improvements }}</pre>
      </div>
    </div>
    {% endif %}

    <div class="card">
      <h2>üí° Alternative Hooks to Test</h2>
      {% if hooks and hooks | length > 0 %}
        <div class="hooks-grid">
          {% for hook in hooks %}
            <div class="hook-item">"{{ hook }}"</div>
          {% endfor %}
        </div>
        <button class="copy-btn" onclick="copyToClipboard(`{{ hooks | join('\n') }}`)">Copy All Hooks</button>
      {% else %}
        <p>No alternative hooks generated.</p>
      {% endif %}
    </div>

{% if formula or basic_formula %}
<div class="card">
  <h2>üìã Your Reusable Formulas</h2>
  
  <!-- Formula Type Selector -->
  <div class="formula-selector">
    <button class="formula-tab active" data-formula="basic">Basic Structure</button>
    <button class="formula-tab" data-formula="timing">With Timing</button>
    <button class="formula-tab" data-formula="template">Template Format</button>
    <button class="formula-tab" data-formula="psychology">Psychology Framework</button>
  </div>

  <!-- Basic Structure -->
  <div id="basic-formula-content" class="formula-content active">
    <div class="formula-box">
      <h4>üìù Basic Structure</h4>
      <pre class="formula-text">{{ basic_formula or formula }}</pre>
      <button class="copy-btn" data-target="basic-formula-content">Copy Basic Formula</button>
    </div>
  </div>

  <!-- Timing-Based Formula -->
  <div id="timing-formula-content" class="formula-content">
    <div class="formula-box">
      <h4>‚è±Ô∏è Step-by-Step with Timing</h4>
      <pre class="formula-text">{% if timing_formula %}{{ timing_formula }}{% else %}TIMING-BASED FORMULA FOR {{ goal.upper() }}:

0-3 seconds: Hook with strong opener that grabs attention immediately
3-7 seconds: Set clear promise of what they'll learn/discover by the end
Middle section: Build engagement with progressive reveals and retention tactics
Final 10 seconds: Deliver satisfying payoff that fulfills the promise

Key Timing Notes:
- Hook must grab attention in first 1-2 seconds
- Promise clarification by 5-second mark  
- Save strongest revelation for final moments
- End with engagement trigger (question/challenge){% endif %}</pre>
      <button class="copy-btn" data-target="timing-formula-content">Copy Timing Formula</button>
    </div>
  </div>

  <!-- Template Format -->
  <div id="template-formula-content" class="formula-content">
    <div class="formula-box">
      <h4>üìã Template Format</h4>
      <pre class="formula-text">{% if template_formula %}{{ template_formula }}{% else %}TEMPLATE FORMAT FOR {{ goal.replace('_', ' ').upper() }}:

"[STRONG OPENER] + [CLEAR PROMISE] + [ENGAGING BUILD] + [SATISFYING PAYOFF] + [ENGAGEMENT HOOK]"

Example Structure:
"[Controversial statement] + [Promise to explain why] + [Build case with examples] + [Deliver the insight] + [Question to drive comments]"

Fill in your content:
- Strong Opener: ________________
- Clear Promise: ________________  
- Engaging Build: ________________
- Satisfying Payoff: ________________
- Engagement Hook: ________________{% endif %}</pre>
      <button class="copy-btn" data-target="template-formula-content">Copy Template</button>
    </div>
  </div>

  <!-- Psychology Framework -->
  <div id="psychology-formula-content" class="formula-content">
    <div class="formula-box">
      <h4>üß† Psychology Framework</h4>
      <pre class="formula-text">{% if psychology_formula %}{{ psychology_formula }}{% else %}PSYCHOLOGY-BASED RETENTION FRAMEWORK:

1. CURIOSITY GAP CREATION
   ‚Üí Create a question they MUST know the answer to
   ‚Üí Example: "Why your [expertise area] isn't working"

2. PROMISE ESTABLISHMENT  
   ‚Üí What will they learn/gain by watching?
   ‚Üí Time-bound commitment: "in the next 30 seconds"

3. DELAYED GRATIFICATION TACTICS
   ‚Üí Mini-reveals that build anticipation
   ‚Üí "But first, let me tell you about..."
   ‚Üí Progressive disclosure of information

4. SATISFYING PAYOFF DELIVERY
   ‚Üí Answer the curiosity gap completely
   ‚Üí Add bonus insight they didn't expect
   ‚Üí Emotional + practical satisfaction

5. ENGAGEMENT AMPLIFICATION
   ‚Üí Question that drives comments
   ‚Üí Challenge that encourages shares  
   ‚Üí Hook for follow-up content

PSYCHOLOGICAL TRIGGERS:
‚úì Social proof ("Most people don't know...")
‚úì Authority ("As someone who...")  
‚úì Scarcity ("This only works if...")
‚úì Reciprocity ("I'm sharing this because...")
‚úì Curiosity ("The real reason is..."){% endif %}</pre>
      <button class="copy-btn" data-target="psychology-formula-content">Copy Framework</button>
    </div>
  </div>
</div>

<style>
.formula-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 2px solid rgba(102, 126, 234, 0.2);
  padding-bottom: 12px;
}

.formula-tab {
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  border: 1px solid rgba(102, 126, 234, 0.2);
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.formula-tab:hover {
  background: rgba(102, 126, 234, 0.2);
  transform: translateY(-1px);
}

.formula-tab.active {
  background: #667eea;
  color: white;
  box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

.formula-content {
  display: none;
}

.formula-content.active {
  display: block;
  animation: fadeIn 0.3s ease-in;
}

.formula-content h4 {
  margin: 0 0 12px 0;
  color: #4a5568;
  font-size: 1.1rem;
}

.formula-text {
  white-space: pre-wrap;
  font-family: inherit;
  margin: 0;
  line-height: 1.6;
  background: rgba(255, 255, 255, 0.1);
  padding: 16px;
  border-radius: 8px;
}

.copy-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 10px;
  transition: background 0.3s;
}

.copy-btn:hover {
  background: #5a67d8;
}

.copy-btn.copied {
  background: #10b981;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
  .formula-selector {
    justify-content: center;
  }
  
  .formula-tab {
    font-size: 12px;
    padding: 6px 12px;
  }
}
</style>
{% endif %}

// Replace the copy button functionality in your results.html template with this:

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Formula tab switching
  const formulaTabs = document.querySelectorAll('.formula-tab');
  const formulaContents = document.querySelectorAll('.formula-content');
  
  formulaTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const targetFormula = this.getAttribute('data-formula');
      
      // Remove active class from all tabs and contents
      formulaTabs.forEach(t => t.classList.remove('active'));
      formulaContents.forEach(c => c.classList.remove('active'));
      
      // Add active class to clicked tab
      this.classList.add('active');
      
      // Show corresponding content
      const targetContent = document.getElementById(targetFormula + '-formula-content');
      if (targetContent) {
        targetContent.classList.add('active');
      }
    });
  });
  
  // Copy functionality - improved version
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('copy-btn')) {
      let textToCopy = '';
      
      // Check if it's the "Copy All Hooks" button
      if (e.target.textContent.includes('Copy All Hooks')) {
        const hooks = [];
        document.querySelectorAll('.hook-item').forEach(item => {
          hooks.push(item.textContent.replace(/"/g, '').trim());
        });
        textToCopy = hooks.join('\n');
      }
      // Check if it has a data-target attribute
      else if (e.target.hasAttribute('data-target')) {
        const targetId = e.target.getAttribute('data-target');
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
          const textElement = targetElement.querySelector('.formula-text') || targetElement.querySelector('pre');
          if (textElement) {
            textToCopy = textElement.textContent;
          }
        }
      }
      // Otherwise, look for nearby content to copy
      else {
        const nearbyContent = e.target.parentElement.querySelector('pre') || 
                             e.target.parentElement.querySelector('.formula-text');
        if (nearbyContent) {
          textToCopy = nearbyContent.textContent;
        }
      }
      
      if (textToCopy) {
        copyToClipboard(textToCopy, e.target);
      }
    }
  });
  
  function copyToClipboard(text, button) {
    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        showCopySuccess(button);
      }).catch(() => {
        fallbackCopy(text, button);
      });
    } else {
      fallbackCopy(text, button);
    }
  }
  
  function showCopySuccess(button) {
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.classList.add('copied');
    
    setTimeout(() => {
      button.textContent = originalText;
      button.classList.remove('copied');
    }, 2000);
  }
  
  function fallbackCopy(text, button) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      document.execCommand('copy');
      showCopySuccess(button);
    } catch (err) {
      console.error('Copy failed:', err);
      alert('Copy failed. Please try selecting and copying the text manually.');
    }
    
    document.body.removeChild(textArea);
  }
});

// Legacy function for backwards compatibility
function copyToClipboard(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert("Copied to clipboard!");
    }).catch(() => {
      fallbackLegacyCopy(text);
    });
  } else {
    fallbackLegacyCopy(text);
  }
}

function fallbackLegacyCopy(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  document.body.appendChild(textArea);
  textArea.select();
  document.execCommand('copy');
  document.body.removeChild(textArea);
  alert("Copied to clipboard!");
}
</script>
      

    <div class="card">
      <h2>üìú Full Transcript</h2>
      <pre>{{ transcript }}</pre>
    </div>

    <div class="card">
      <h2>üñºÔ∏è Frame Analysis</h2>
      <div class="grid">
        {% for img in frame_gallery %}
          <div class="frame-card"><img src="{{ img }}" alt="Video frame"></div>
        {% endfor %}
      </div>
      
      <!-- Collapsible Frame Details (optional) -->
      <details style="margin-top: var(--space-md);">
        <summary style="cursor: pointer; color: var(--lunar-blush); font-weight: 600;">
          View Frame-by-Frame Analysis (Used for AI Context)
        </summary>
        <div style="max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.05); padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-sm);">
          {% if frame_summaries and frame_summaries | length > 1 %}
            {% for block in frame_summaries %}
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px; margin: 8px 0; font-size: 0.9rem;">
                <pre style="white-space: pre-wrap; margin: 0; font-family: inherit;">{{ block }}</pre>
              </div>
            {% endfor %}
          {% else %}
            <pre style="white-space: pre-wrap; margin: 0; font-family: inherit; font-size: 0.9rem;">{{ frame_summary | default(frames_summaries_text, true) }}</pre>
          {% endif %}
        </div>
      </details>
    </div>

    <a href="/" class="back-link">‚Üê Analyze Another Video</a>
  </div>
</body>
</html>